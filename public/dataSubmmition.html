<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read CSV File</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script type="text/javascript" src="js/codeDataLoad.js"></script>
    <script type="text/javascript" src="js/codeGraphicsGen.js"></script>
</head>
</head>
<body>
    <button onclick="toMainPage()">חזור לגרפיקה</button>
    <br></br>
    <input type="file" id="csvFileInput" accept=".csv">
    <button onclick="readCSV(processData)">Read CSV</button>
    <button onclick="readCSV(previewData)">preview CSV</button>

    <br></br>
    <div id="previewGraphicsContainer"></div>
    
</body>
<script>
    var selected_region=0;

    function toMainPage() {
    // Replace 'target.html' with the actual file name or path of the HTML page you want to redirect to
        window.location.href = 'index.html';
    }

    // function generateGraphicsFor(jd){
    //     const GraphicContainer=document.createElement("div");
    //     GraphicContainer.classList.add("centered");
    //     GraphicContainer.classList.add("graphicContainer");
    //     graphics.appendChild(GraphicContainer);


    //     console.log("promise from code.js",jd);
    //     let resJson=jd.res_profline;
    //     let superMeasureData=jd.super_measurements;
        
    //     generateGraphics(jd,GraphicContainer);   


    // }

</script>

<script>
    fetch('api/getColumnNames').then(response => response.json()).then(data=>{
        console.log("collumns names", Object.keys(data[0]));
        let s="";
        for(let i=0;i<data.length;i++){
            s+=data[i]["COLUMN_NAME"]+",";
        }
        console.log(s);
    }
    ); //was for testing



    function calculateSuperMeasures(measures){
        
    }
    function validateCSV(csvData){
        if (csvData.length>1){
           alert('the file cannot have more than 1 line');
           return false;
        }
        if(Object.keys(csvData[0]).length!=41){
            alert('wrong number of measures');
            return false;
        }


        return true;
    }


    function previewData(csvData){
        console.log("csv in preview",csvData);
       
        const csvRow=csvData[0];
        const newTableRow={};
        
        console.log("newTableRow",newTableRow);
        console.log("csvrow",csvRow);

        fetch('/api/getData')
        .then(response => response.json())
        .then(data => {

            const columnKeys=Object.keys(data[0]);
            for(let i=0;i<columnKeys.length;i++){
                const columnName = columnKeys[i];
                newTableRow[columnName]=csvRow[i].toString();
            }
            console.log("newTableRow after input",newTableRow);

            data.push(newTableRow)
            console.log("data after row added",data);
            const selected_region=data.length-1;
            const previewContainer=document.getElementById("previewGraphicsContainer");

            generateGraphicsFor(previewContainer,covertTableToJson(data),selected_region);
        })
        .catch(error => console.error('Error fetching data:', error));


    }

    function processData(csvData) {
    // Process the CSV data as needed
        // For example, log each row to the console
       
        csvRow=csvData[0];
        console.log("csv first row", csvRow);
        let allCollumns={};
        fetch('api/getColumnNames').then(response => response.json()).then(data=>{
            const Keys=Object.keys(data[0]);
            for(let i=0;i<Keys.length;i++){
                const columnName = Keys[i];
                let value =csvRow[i];
                allCollumns[columnName]=value;
                console.log(columnName,value);
            }
            console.log("all columns",allCollumns);
            const d =JSON.stringify(allCollumns); 
            console.log("stringfy",d);
            
            fetch('api/insertData', {
                method: 'POST',
                body: d,
                headers: {
                    'Content-Type': 'application/json',
                },
               
            })
            .then(response => {
                if (!response.ok) {
                    console.log("repose",response);
                throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                console.log('Success:', data);
                alert("נתונים הוזנו בהצלחה")
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error)
            });
        });




    }
    function readCSV(funcProcess) {
        const fileInput = document.getElementById('csvFileInput');
        const file = fileInput.files[0];

        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const csvContent = e.target.result;

                // Parse the CSV content using Papa Parse
                Papa.parse(csvContent, {
                    complete: function (result) {
                        // Result.data is an array of arrays containing the CSV values
                        console.log("reading csv",result.data);
                        if(!validateCSV(result.data)){
                            return;
                        }
                        // Process the CSV data as needed
                        funcProcess(result.data);
                    },
                    header: false, // Set to true if the first row contains column headers
                    dynamicTyping: true, // Automatically convert strings to numbers or booleans
                });
            };

            reader.readAsText(file);
        } else {
            alert('Please select a CSV file.');
        }
    }
</script>

</html>