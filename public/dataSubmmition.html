<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read CSV File</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
</head>
<body>
    <input type="file" id="csvFileInput" accept=".csv">
    <button onclick="readCSV()">Read CSV</button>

</body>
<script>
</script>

<script>
    fetch('api/getColumnNames').then(response => response.json()).then(data=>{
        // console.log("collumns names", data.map(row=>row["COLUMN_NAME"]));
        let s="";
        for(let i=0;i<data.length;i++){
            s+=data[i]["COLUMN_NAME"]+",";
        }
        console.log(s);
    }
    ); //was for testing
    

    function processData(csvData) {
        // Process the CSV data as needed
        // For example, log each row to the console
        if (csvData.length>1){
           alert('the file cannot have more than 1 line');
           return
        }
        csvRow=csvData[0];
        console.log("csv first row", csvRow);
        let allCollumns={};
        fetch('api/getColumnNames').then(response => response.json()).then(data=>{
            for(let i=0;i<data.length;i++){
                const columnName = data[i]["COLUMN_NAME"];
                allCollumns[columnName]=csvRow[i];
            }
            
            const d =JSON.stringify(allCollumns); 
            console.log("stringfy",d);
            
            fetch('api/insertData', {
                method: 'POST',
                body: d,
                headers: {
                    'Content-Type': 'application/json',
                },
               
            })
            .then(response => {
                if (!response.ok) {
                    console.log("repose",response);
                throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                console.log('Success:', data);
                alert("נתונים הוזנו בהצלחה")
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error)
            });
        });




    }
    function readCSV() {
        const fileInput = document.getElementById('csvFileInput');
        const file = fileInput.files[0];

        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const csvContent = e.target.result;

                // Parse the CSV content using Papa Parse
                Papa.parse(csvContent, {
                    complete: function (result) {
                        // Result.data is an array of arrays containing the CSV values
                        console.log(result.data);
                        
                        // Process the CSV data as needed
                        processData(result.data);
                    },
                    header: false, // Set to true if the first row contains column headers
                    dynamicTyping: true, // Automatically convert strings to numbers or booleans
                });
            };

            reader.readAsText(file);
        } else {
            alert('Please select a CSV file.');
        }
    }
</script>

</html>