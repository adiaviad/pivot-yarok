
<!DOCTYPE html>
<html>
    <meta charset="UTF-8">
        <link rel="stylesheet" href="style.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script type="text/javascript" src="js/codeDataLoad.js"></script>
    <script type="text/javascript" src="js/codeGraphicsGen.js"></script>

    <body>
        <h2>WIP</h2>
        <h2 id="loading" class="loading" style="display: none; align-self: center;"></h2>
        <button onclick="redirectToSubmit()" class="selector">לעומד הכנסת מידע</button>
        
        <table class="right">
            <tr class="right">
                <td class="right"><input type="number" id="yearinput" value="2021"></input></td>
                <td class="right"><button onclick="reselect()">בחר שנה</button></td>

            </tr>
        </table>
        <div id='checkbox-container-provinces' class="checkbox_container" style="margin-bottom: 2%;padding-bottom:20px ;"></div>
        <div id='checkbox-container-superMeasures' class="checkbox_container" style="margin-bottom: 2%;padding-bottom:20px ;"></div>

        <div id="graphicsContainer" class="centered"></div>

    </body>
</html>
<script>
    function loadingPopup(txt,timeout_ms){
        const l=document.getElementById("loading");
        l.textContent=txt
        l.style.display='flex';
        setTimeout(()=> {l.style.display='none';},timeout_ms);
    }
    function redirectToSubmit() {
      // Replace 'target.html' with the actual file name or path of the HTML page you want to redirect to
      window.location.href = 'dataSubmmition.html';
    }
    function updateFilterDisplays(from_group){
        const selectedProvinces = [];
        const checkboxes = document.querySelectorAll(`.${from_group} input[type="checkbox"]:checked`);

        checkboxes.forEach(checkbox => selectedProvinces.push(checkbox.name));
        
        const displays=Array.from(document.getElementsByClassName("displayFilter"));
        const year =document.getElementById("yearinput").value;
 
        displays.forEach(element=>{
            element.textContent= selectedProvinces.length>0 ?"  שנה:"+year+" "+" "+"רשויות: "+selectedProvinces.join(", ") :"" ;
        });
        console.log("slected names",selectedProvinces.join(","));

    }
    function getSelectedCheckboxesGroup(group) {
        const selectedCheckboxes = [];
        const checkboxes = document.querySelectorAll(`.${group} input[type="checkbox"]:checked`);

        checkboxes.forEach(checkbox => {
            selectedCheckboxes.push(checkbox.value);
        });
        
        sortedIDs=selectedCheckboxes.sort((a, b) => a - b);
        
        console.log(sortedIDs);
        
        return sortedIDs;

    }
    function createCheckBoxForSuperMeasure(){
//superMeasures
        const elems= document.getElementsByClassName("superMeasureGraphic");
        let names=[];
        for (let i = 0; i < elems.length; i++) {
            names.push(elems[i].id);
            
        }
        console.log("super measure names",names);
        createCheckboxes(names,"superMeasures",()=>updateSuperMeasureDisplay());
    }

    function updateSuperMeasureDisplay(){
        const group="superMeasures";
        const checkedBoxes = document.querySelectorAll(`.${group} input[type="checkbox"]`);
        const arr=[];
        for (let i = 0; i < checkedBoxes.length; i++) {
            const element = checkedBoxes[i];
            const sm=document.getElementById(element.name);
            if(element.checked){
                sm.style.display="";
            }else{
                sm.style.display="none";
            }
        }      

    }


    function createCheckboxes(names,group,func) {
        const checkboxContainer = document.getElementById("checkbox-container-"+group);
        checkboxContainer.innerHTML="";
        checkboxContainer.classList.add(group);
        console.log("names",names);
        for (let i=0;i<names.length;i++){
            const name =names[i];
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = i;
            checkbox.name = name;
            checkbox.checked=true;
            checkbox.classList.add("checkbox");
            

            const label = document.createElement('label');
            label.htmlFor = name;
            label.appendChild(document.createTextNode(name));
            const inputContainter=document.createElement('c');
            inputContainter.appendChild(checkbox);
            inputContainter.appendChild(label);
            checkboxContainer.appendChild(inputContainter);
            

            // Attach change event listener to each checkbox
            checkbox.addEventListener('change', func);
        }
    }

</script>


<script>
    
    const graphicsContainer=document.getElementById("graphicsContainer");
    function reselect(){
        fetchYear(document.getElementById("yearinput").value);
    }
    function fetchYear(year){
        if(!isFinite(year)){
            alert("שנה לא תקינה")
            return;
        }
        fetch('/api/getData/'+year)
        .then(response => response.json())
        .then(data => {
            jd=covertTableToJson(data);
            let provinces_names=jd[0].res_profline.provinces_names;
            createCheckboxes(provinces_names,"provinces",()=>{
                const slectedIDs= getSelectedCheckboxesGroup("provinces");
                const newData= sortedIDs.map(ID=>data[ID]);
                generateGraphicsFor(graphicsContainer,covertTableToJson(newData),0,()=>updateFilterDisplays("provinces"));
                createCheckBoxForSuperMeasure();
            });
            
            generateGraphicsFor(graphicsContainer,jd,0,()=>updateFilterDisplays("provinces"));
            createCheckBoxForSuperMeasure();
            
        })
        .catch(error => console.error("קרתה שגיאה"));
    }
    // function populateYearSelect(){
    //     console.log("pop years");
    //     selectElm=document.getElementById("yearinput");
    //     fetch("api/allyears").then(response=>response.json).then(data=>
    //     {

    //         console.log(data[0]);
    //         data.forEach(row=>{
    //             option=document.createElement("option");
    //             option.value=row;
    //             option.innerHTML=row;
    //             selectElm.appendChild(option);
    //         });
    //     });
    // }
    // populateYearSelect();
    fetchYear(2021);
</script>
